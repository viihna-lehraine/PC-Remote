name: CI/CD Pipeline

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    build-test:
        name: Build & Test
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: 'pnpm'

            - name: Debug PNPM Installation
              run: |
                  echo "Checking Node.js version:"
                  node -v
                  echo "Checking PNPM version:"
                  pnpm --version
                  echo "Listing project dependencies:"
                  pnpm list

            - name: Install dependencies
              run: pnpm install -no-frozen-lockfile || (echo "Failed to install dependencies ❌" && exit 1)

            - name: Build frontend
              run: pnpm --filter frontend run build || (echo "Build failed ❌" && exit 1)

            - name: Build backend
              run: pnpm --filter backend run build || (echo "Build failed ❌" && exit 1)

            - name: Notify Discord on success
              if: success()
              run: |
                  curl -H "Content-Type: application/json" \
                       -X POST \
                       -d '{"content": "**PC Remote Build & Test Passed!**"}' \
                       ${{ secrets.DISCORD_WEBHOOK }}

            - name: Notify Discord on failure
              if: failure()
              run: |
                  curl -H "Content-Type: application/json" \
                       -X POST \
                       -d '{"content": "**PC Remote Build & Test Failed!** ❌"}' \
                       ${{ secrets.DISCORD_WEBHOOK }}
